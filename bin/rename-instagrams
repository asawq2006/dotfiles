#!/usr/bin/env ruby
# jm3 + www.jm3.net + github.com/jm3 + twitter.com/jm3

require 'fileutils'

# i use IFTT (If This Then That) to automatically download my
# Instagrams + Instagram Likes to my Dropbox. The only problem is,
# IFTT uses a boneheaded date format that fucks up the alphabetical
# sorting, e.g. December (D) comes before January (j). Doh. this
# script renames the files according to a sane naming schema and
# it handles both your photos + your likes.

# your photos will be named like this:
# February_09__2014_at_0547PM_instagram.jm3.Backgammoning.jpg
# => 2014-02-09 05.47pm instagram - Backgammoning.jpg

# your likes will be named like this
# February_09__2014_at_0547PM_instagramfave.sv4.Backgammoning.jpg
# => instagram fave 2014-02-09 05.47pm - sv4 - Backgammoning.jpg

# add whatever directories you want to process here. 
dirs = [
    "~/Dropbox/Photos/Instagrams",
    "~/Dropbox/Photos/Instagram Likes"
  ].map{ |d| File.expand_path d }

# You should not need to change anything below this line.

running_user = `whoami`.chomp

dirs.each do |dir|
  if File.directory? dir
    Dir.chdir dir
    Dir["*.jpg"].each do |insta|
      before = insta
      after = before.gsub( /__/, " - ")

      parser = %r{([^_]+)_(\d+)__(\d{4})_at_(\d{4})([AP]M)_(\w+)\.([\w+]+)\.(\w+)\.(\w+)}
      # example filename generated by IFTT recipe:
      # January_25__2014_at_0937PM_instagram.jm3__yohjiyamamoto__y3_lights.jpg

      tokens = parser.match( before )
      if tokens
        month   = Date::MONTHNAMES.index( tokens[1])
        month   = sprintf( "%02d", month ) # indexes are ints so zero-pad
        day     = tokens[2]
        year    = tokens[3]
        time    = tokens[4].gsub(/(\d{2})(\d{2})/, "\\1.\\2")
        am_pm   = tokens[5].downcase
        network = tokens[6]
        user    = tokens[7]
        desc    = tokens[8].gsub(/_+/, ' ')
        ext     = tokens[9]

        p tokens

        # Likes get a special prefix of "instagram fave" 
        prefix  = (network == "instagramfave") ? "instagram fave " : ""
        network = (user == running_user) ? "instagram" : ""
        user =    (user == running_user) ? "" : "#{user} - "

        after  = prefix + [year, month, day].join( "-" ) + " #{time}pm #{network} - #{user}#{desc}.#{ext}"

        # IFTT suppresses a lot of the possible filename characters
        # (#, ', etc.), which means you'll often end up with filenames
        # with dozens of extra spaces; this cleans them up.
        after.gsub!(/  /, ' ')

        puts "mv #{before} #{after}"
        FileUtils.mv before, after
      end
    end
  end
end

