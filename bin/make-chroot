#!/bin/sh
# chroot jail creator for OS X 10.6.8-ish. dugsong would be proud.
# by jm3@jm3.net / john manoogian III

min_version="10.6.8"
chroot_dir=$HOME/chroot

# you shouldn't need to change anything below this line:

# verify os x version:
system_profiler | grep "System Version: Mac OS X $min_version" > /dev/null
installed_version_matches_min=$?
if [ "$installed_version_matches_min" = 0 ]
then
  echo "Creating directories, copying binaries and libs, baking donuts..."
else
  echo "WARNING! This script was only tested on OS X version $min_version. Proceed with caution!"
  exit 1
fi

mkdir -p $chroot_dir/bin
mkdir -p $chroot_dir/usr/lib

bins="[ cat chmod cp date dd df domainname echo expr hostname kill link ln ls mkdir mv pax ps pwd rm rmdir sh sleep stty test unlink"
libs="dyld libgcc_s.1.dylib libiconv.2.dylib system/libmathCommon.A.dylib libncurses.5.4.dylib libSystem.B.dylib"

for binary in $bins
do
  cp /bin/$binary $chroot_dir/bin/
done

for lib in $libs
do
  cp /usr/lib/$lib $chroot_dir/usr/lib/
done

# manually copy vim since it's not in /bin with the rest of the binaries we need:
cp /usr/bin/vim $chroot_dir/bin/vim

echo "root password to chown your chroot contents to nobody:nobody"
sudo chown -R nobody:nobody $chroot_dir

echo "Success! Use your new chroot jail like this: sudo chroot $chroot_dir /bin/sh"

exit 0
